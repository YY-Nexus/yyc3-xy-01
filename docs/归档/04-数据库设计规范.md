---
文档编号: YYC3-DBDESIGN-001
文档名称: 数据库设计规范
版本: 1.0.0
创建日期: 2024-12-08
最后更新: 2024-12-08
作者: YYC团队
审批人: YYC
---

# 数据库设计规范

## 1. 文档信息

- **文档目的**: 规范YYC³ AI小语智能成长守护系统的数据库设计，确保数据结构合理、高效、可扩展
- **适用范围**: 系统开发人员、数据库管理员
- **术语定义**:
  - AI小语: YYC³ AI小语智能成长守护系统的简称
  - 成长记录: 记录孩子成长过程中的重要事件、里程碑、观察等
  - 评估报告: 基于成长记录生成的孩子发展评估
  - 互动记录: 记录亲子互动、学习活动等

## 2. 数据库架构概述

### 2.1 整体架构

YYC³系统采用多层数据库架构，支持不同部署环境:

- **开发环境**: 采用SQLite轻量级数据库，便于开发和测试
- **生产环境**: 采用PostgreSQL关系型数据库，支持高并发和复杂查询
- **客户端存储**: 使用LocalStorage进行数据缓存和离线支持
- **云存储**: 使用Supabase Storage存储媒体文件

### 2.2 数据存储策略

- **结构化数据**: 存储在关系型数据库中
- **半结构化数据**: 使用JSON类型存储（如配置信息、AI分析结果）
- **媒体文件**: 存储在对象存储服务中，数据库中仅保存文件路径
- **缓存数据**: 关键数据在客户端进行缓存，提高响应速度

## 3. 核心数据模型

### 3.1 用户与角色

```typescript
// 用户信息
export interface User {
  id: string;              // 用户唯一标识
  email: string;           // 邮箱地址
  password: string;        // 加密后的密码
  name: string;            // 用户名称
  avatar_url?: string;     // 头像URL
  created_at: string;      // 创建时间
  updated_at?: string;     // 更新时间
}

// 孩子信息
export interface ChildProfile {
  id: string;              // 孩子唯一标识
  user_id: string;         // 关联的用户ID
  name: string;            // 孩子姓名
  nickname?: string;       // 昵称
  birthDate: string;       // 出生日期
  gender: "male" | "female" | "other"; // 性别
  avatar?: string;         // 头像URL
  currentStage: AgeStage;  // 当前成长阶段
  traits: string[];        // 性格特质
  interests: string[];     // 兴趣爱好
  created_at: string;      // 创建时间
  updated_at?: string;     // 更新时间
}
```

### 3.2 成长记录

```typescript
// 成长阶段
export type AgeStage =
  | "0-3"    // 感官启蒙期
  | "3-6"    // 游戏化学习期
  | "6-9"    // 学术奠基期
  | "9-12"   // 思维建构期
  | "12-15"  // 青春转型期
  | "15-18"  // 生涯定位期
  | "18-22"; // 成人成才期

// 成长记录
export interface GrowthRecord {
  id: string;              // 记录唯一标识
  child_id: string;        // 关联的孩子ID
  date: string;            // 记录日期
  type: "milestone" | "observation" | "media" | "emotion"; // 记录类型
  title: string;           // 记录标题
  content: string;         // 记录内容
  tags: string[];          // 标签
  media_urls?: string[];   // 媒体文件URL列表
  emotion_score?: number;  // 情绪评分（1-10）
  age_stage: AgeStage;     // 成长阶段
  dimensions?: string[];   // 发展维度
  created_at: string;      // 创建时间
  updated_at?: string;     // 更新时间
}

// 成长评估
export interface GrowthAssessment {
  id: string;              // 评估唯一标识
  child_id: string;        // 关联的孩子ID
  date: string;            // 评估日期
  age_stage: AgeStage;     // 成长阶段
  overall_score: number;   // 综合评分
  dimension_scores: Record<string, number>; // 维度评分
  strengths: string[];     // 优势
  improvements: string[];  // 需要改进的地方
  recommendations: string[]; // 建议
  next_milestones: string[]; // 下一步里程碑
  created_at: string;      // 创建时间
  updated_at?: string;     // 更新时间
}

// 里程碑
export interface Milestone {
  id: string;              // 里程碑唯一标识
  child_id: string;        // 关联的孩子ID
  milestone_type: "academic" | "social" | "physical" | "emotional" | "creative"; // 里程碑类型
  title: string;           // 里程碑标题
  description: string;     // 里程碑描述
  achieved_at: string;     // 达成时间
  celebration_data?: {     // 庆祝数据
    shared: boolean;       // 是否分享
    reactions: number;     // 点赞数
  };
  created_at: string;      // 创建时间
  updated_at?: string;     // 更新时间
}
```

### 3.3 互动与学习

```typescript
// 互动记录
export interface InteractionRecord {
  id: string;              // 记录唯一标识
  child_id: string;        // 关联的孩子ID
  parent_id: string;       // 关联的家长ID
  type: InteractionType;   // 互动类型
  title: string;           // 标题
  content: string;         // 内容
  media_urls: string[];    // 媒体文件URL列表
  duration: number;        // 持续时间（分钟）
  participants: string[];  // 参与者
  location: string;        // 地点
  mood: MoodType;          // 情绪
  ai_analysis: InteractionAnalysis | null; // AI分析结果
  tags: string[];          // 标签
  created_at: string;      // 创建时间
  updated_at?: string;     // 更新时间
}

// 课程表
export interface Course {
  id: string;              // 课程唯一标识
  child_id: string;        // 关联的孩子ID
  name: string;            // 课程名称
  subject: string;         // 学科
  teacher: string;         // 教师
  location: string;        // 地点
  type: "school" | "extracurricular" | "online"; // 课程类型
  color: string;           // 颜色标识
  schedules: CourseSchedule[]; // 课程安排
  notes: string;           // 备注
  is_active: boolean;      // 是否激活
  created_at: string;      // 创建时间
  updated_at?: string;     // 更新时间
}

// 课程安排
export interface CourseSchedule {
  id: string;              // 安排唯一标识
  course_id: string;       // 关联的课程ID
  day_of_week: number;     // 星期（1-7）
  start_time: string;      // 开始时间（"08:00"）
  end_time: string;        // 结束时间（"08:45"）
  room: string;            // 教室
}

// 日程安排
export interface Schedule {
  id: string;              // 日程唯一标识
  child_id: string;        // 关联的孩子ID
  title: string;           // 标题
  description?: string;    // 描述
  type: ScheduleType;      // 日程类型
  start_time: string;      // 开始时间
  end_time: string;        // 结束时间
  repeat?: RepeatRule;     // 重复规则
  reminder?: ReminderConfig; // 提醒配置
  ai_generated: boolean;   // 是否由AI生成
  completed: boolean;      // 是否完成
  color: string;           // 颜色标识
  created_at: string;      // 创建时间
  updated_at?: string;     // 更新时间
}
```

### 3.4 AI生成内容

```typescript
// AI对话历史
export interface AIChat {
  id: string;              // 对话唯一标识
  child_id: string;        // 关联的孩子ID
  type: "text" | "voice" | "image"; // 对话类型
  content: string;         // 对话内容
  is_user: boolean;        // 是否为用户消息
  timestamp: string;       // 时间戳
  context?: Record<string, any>; // 上下文信息
}

// 生成的视频
export interface GeneratedVideo {
  id: string;              // 视频唯一标识
  child_id: string;        // 关联的孩子ID
  type: VideoType;         // 视频类型
  title: string;           // 视频标题
  description: string;     // 视频描述
  video_url: string;       // 视频URL
  thumbnail_url: string;   // 缩略图URL
  duration: number;        // 视频时长
  style: VideoStyle;       // 视频风格
  source_images: string[]; // 源图片列表
  voiceover_text?: string; // 旁白文本
  music_style?: MusicStyle; // 音乐风格
  status: "processing" | "completed" | "failed"; // 状态
  progress: number;        // 进度（0-100）
  is_favorite: boolean;    // 是否收藏
  view_count: number;      // 观看次数
  created_at: string;      // 创建时间
  updated_at?: string;     // 更新时间
}

// 绘本故事
export interface AIBook {
  id: string;              // 绘本唯一标识
  child_id: string;        // 关联的孩子ID
  title: string;           // 绘本标题
  cover_image: string;     // 封面图片URL
  content: string;         // 绘本内容
  style: ArtStyle;         // 插画风格
  characters: string[];    // 角色列表
  category: BookCategory;  // 分类
  is_favorite: boolean;    // 是否收藏
  read_count: number;      // 阅读次数
  current_page: number;    // 当前阅读页
  total_pages: number;     // 总页数
  started_at: string;      // 开始阅读时间
  last_read_at: string;    // 最后阅读时间
  is_completed: boolean;   // 是否完成阅读
  created_at: string;      // 创建时间
  updated_at?: string;     // 更新时间
}
```

### 3.5 系统配置

```typescript
// 阶段转换记录
export interface StageTransition {
  id: string;              // 转换记录唯一标识
  child_id: string;        // 关联的孩子ID
  from_stage: AgeStage;    // 原阶段
  to_stage: AgeStage;      // 新阶段
  transition_date: string; // 转换日期
  notes?: string;          // 备注
  created_at: string;      // 创建时间
}

// 作业任务
export interface HomeworkTask {
  id: string;              // 任务唯一标识
  child_id: string;        // 关联的孩子ID
  title: string;           // 任务标题
  description: string;     // 任务描述
  due_date: string;        // 截止日期
  status: "pending" | "in_progress" | "completed" | "overdue"; // 状态
  priority: "low" | "medium" | "high"; // 优先级
  subject: string;         // 学科
  media_urls?: string[];   // 媒体文件URL列表
  created_at: string;      // 创建时间
  updated_at?: string;     // 更新时间
}
```

## 4. 数据库表结构

### 4.1 核心表结构

#### 用户表 (users)
| 字段名 | 数据类型 | 约束 | 描述 |
|--------|----------|------|------|
| id | UUID | PRIMARY KEY | 用户唯一标识 |
| email | VARCHAR(255) | UNIQUE NOT NULL | 邮箱地址 |
| password | VARCHAR(255) | NOT NULL | 加密后的密码 |
| name | VARCHAR(255) | NOT NULL | 用户名称 |
| avatar_url | VARCHAR(512) | | 头像URL |
| created_at | TIMESTAMP | NOT NULL | 创建时间 |
| updated_at | TIMESTAMP | | 更新时间 |

#### 孩子表 (children)
| 字段名 | 数据类型 | 约束 | 描述 |
|--------|----------|------|------|
| id | UUID | PRIMARY KEY | 孩子唯一标识 |
| user_id | UUID | REFERENCES users(id) | 关联的用户ID |
| name | VARCHAR(255) | NOT NULL | 孩子姓名 |
| nickname | VARCHAR(255) | | 昵称 |
| birth_date | DATE | NOT NULL | 出生日期 |
| gender | VARCHAR(10) | NOT NULL | 性别 |
| avatar | VARCHAR(512) | | 头像URL |
| current_stage | VARCHAR(20) | NOT NULL | 当前成长阶段 |
| traits | JSONB | DEFAULT '[]' | 性格特质 |
| interests | JSONB | DEFAULT '[]' | 兴趣爱好 |
| created_at | TIMESTAMP | NOT NULL | 创建时间 |
| updated_at | TIMESTAMP | | 更新时间 |

#### 成长记录表 (growth_records)
| 字段名 | 数据类型 | 约束 | 描述 |
|--------|----------|------|------|
| id | UUID | PRIMARY KEY | 记录唯一标识 |
| child_id | UUID | REFERENCES children(id) | 关联的孩子ID |
| date | DATE | NOT NULL | 记录日期 |
| type | VARCHAR(20) | NOT NULL | 记录类型 |
| title | VARCHAR(255) | NOT NULL | 记录标题 |
| content | TEXT | NOT NULL | 记录内容 |
| tags | JSONB | DEFAULT '[]' | 标签 |
| media_urls | JSONB | DEFAULT '[]' | 媒体文件URL列表 |
| emotion_score | INTEGER | | 情绪评分 |
| age_stage | VARCHAR(20) | NOT NULL | 成长阶段 |
| dimensions | JSONB | DEFAULT '[]' | 发展维度 |
| created_at | TIMESTAMP | NOT NULL | 创建时间 |
| updated_at | TIMESTAMP | | 更新时间 |

#### 成长评估表 (growth_assessments)
| 字段名 | 数据类型 | 约束 | 描述 |
|--------|----------|------|------|
| id | UUID | PRIMARY KEY | 评估唯一标识 |
| child_id | UUID | REFERENCES children(id) | 关联的孩子ID |
| date | DATE | NOT NULL | 评估日期 |
| age_stage | VARCHAR(20) | NOT NULL | 成长阶段 |
| overall_score | INTEGER | NOT NULL | 综合评分 |
| dimension_scores | JSONB | DEFAULT '{}' | 维度评分 |
| strengths | JSONB | DEFAULT '[]' | 优势 |
| improvements | JSONB | DEFAULT '[]' | 需要改进的地方 |
| recommendations | JSONB | DEFAULT '[]' | 建议 |
| next_milestones | JSONB | DEFAULT '[]' | 下一步里程碑 |
| created_at | TIMESTAMP | NOT NULL | 创建时间 |
| updated_at | TIMESTAMP | | 更新时间 |

#### 互动记录表 (interaction_records)
| 字段名 | 数据类型 | 约束 | 描述 |
|--------|----------|------|------|
| id | UUID | PRIMARY KEY | 记录唯一标识 |
| child_id | UUID | REFERENCES children(id) | 关联的孩子ID |
| parent_id | UUID | REFERENCES users(id) | 关联的家长ID |
| type | VARCHAR(20) | NOT NULL | 互动类型 |
| title | VARCHAR(255) | NOT NULL | 标题 |
| content | TEXT | NOT NULL | 内容 |
| media_urls | JSONB | DEFAULT '[]' | 媒体文件URL列表 |
| duration | INTEGER | NOT NULL | 持续时间（分钟） |
| participants | JSONB | DEFAULT '[]' | 参与者 |
| location | VARCHAR(255) | NOT NULL | 地点 |
| mood | VARCHAR(20) | NOT NULL | 情绪 |
| ai_analysis | JSONB | | AI分析结果 |
| tags | JSONB | DEFAULT '[]' | 标签 |
| created_at | TIMESTAMP | NOT NULL | 创建时间 |
| updated_at | TIMESTAMP | | 更新时间 |

### 4.2 索引设计

```sql
-- 用户表索引
CREATE INDEX idx_users_email ON users(email);

-- 孩子表索引
CREATE INDEX idx_children_user_id ON children(user_id);

-- 成长记录表索引
CREATE INDEX idx_growth_records_child_id ON growth_records(child_id);
CREATE INDEX idx_growth_records_date ON growth_records(date);
CREATE INDEX idx_growth_records_type ON growth_records(type);
CREATE INDEX idx_growth_records_age_stage ON growth_records(age_stage);

-- 成长评估表索引
CREATE INDEX idx_growth_assessments_child_id ON growth_assessments(child_id);
CREATE INDEX idx_growth_assessments_date ON growth_assessments(date);

-- 互动记录表索引
CREATE INDEX idx_interaction_records_child_id ON interaction_records(child_id);
CREATE INDEX idx_interaction_records_type ON interaction_records(type);
CREATE INDEX idx_interaction_records_created_at ON interaction_records(created_at);

-- 课程表索引
CREATE INDEX idx_courses_child_id ON courses(child_id);
CREATE INDEX idx_courses_subject ON courses(subject);

-- 日程表索引
CREATE INDEX idx_schedules_child_id ON schedules(child_id);
CREATE INDEX idx_schedules_start_time ON schedules(start_time);

-- AI生成内容表索引
CREATE INDEX idx_generated_videos_child_id ON generated_videos(child_id);
CREATE INDEX idx_generated_videos_status ON generated_videos(status);
CREATE INDEX idx_ai_books_child_id ON ai_books(child_id);
CREATE INDEX idx_ai_books_category ON ai_books(category);
```

## 5. 数据访问层设计

### 5.1 数据访问接口

系统设计了统一的数据访问接口，支持不同数据库实现:

```typescript
// 数据库客户端接口
export interface DatabaseClient {
  // 连接管理
  connect(): Promise<void>;
  disconnect(): Promise<void>;
  
  // 基本操作
  findOne<T>(table: string, id: string): Promise<T | null>;
  findFirst<T>(table: string, filter: any): Promise<T | null>;
  findMany<T>(table: string, filter?: any): Promise<T[]>;
  create<T>(table: string, data: any): Promise<T>;
  createMany<T>(table: string, dataArray: any[]): Promise<T[]>;
  update<T>(table: string, id: string, data: any): Promise<T | null>;
  delete(table: string, id: string): Promise<boolean>;
  deleteMany(table: string, ids: string[]): Promise<number>;
  count(table: string, filter?: any): Promise<number>;
  aggregate<T, R>(table: string, aggregator: (items: T[]) => R): Promise<R>;
  paginate<T>(table: string, options: PaginationOptions<T>): Promise<PaginationResult<T>>;
  
  // 事务管理
  transaction<T>(fn: (tx: DatabaseClient) => Promise<T>): Promise<T>;
}
```

### 5.2 实现类

系统提供了三种数据库实现:

1. **LocalStorageDB**: 客户端存储实现，用于开发和离线场景
2. **SQLiteClient**: SQLite数据库实现，用于轻量级部署
3. **SupabaseClient**: Supabase数据库实现，用于生产环境

## 6. 数据迁移策略

### 6.1 版本管理

使用数据库迁移工具管理 schema 变更，每个迁移文件包含:

- 版本号
- 变更描述
- 升级脚本
- 回滚脚本

### 6.2 迁移流程

1. 开发人员创建迁移文件
2. 测试环境验证迁移
3. 生产环境执行迁移
4. 监控迁移执行情况

### 6.3 数据同步

- 客户端与服务端数据同步采用增量同步策略
- 关键数据变更通过WebSocket实时通知
- 定期进行全量同步，确保数据一致性

## 7. 数据安全与隐私

### 7.1 数据加密

- 敏感数据（如密码）采用BCrypt进行加密存储
- 传输过程采用HTTPS加密
- 数据库存储层可选择透明数据加密

### 7.2 访问控制

- 基于角色的访问控制（RBAC）
- 细粒度的权限管理
- 定期权限审计

### 7.3 隐私保护

- 遵守相关隐私法规（如GDPR、CCPA）
- 提供数据删除和导出功能
- 最小化数据收集，只收集必要信息

## 8. 性能优化

### 8.1 查询优化

- 使用适当的索引
- 避免全表扫描
- 优化复杂查询
- 使用分页查询减少数据传输

### 8.2 缓存策略

- 客户端缓存热点数据
- 使用Redis等缓存中间件
- 合理设置缓存过期时间

### 8.3 写入优化

- 批量写入减少数据库负载
- 异步写入非关键数据
- 使用队列处理大量写入操作

## 9. 监控与维护

### 9.1 监控指标

- 数据库连接数
- 查询响应时间
- 错误率
- 磁盘空间使用率
- 备份状态

### 9.2 备份策略

- 定期全量备份
- 增量备份
- 异地备份
- 备份验证

### 9.3 维护任务

- 定期清理过期数据
- 更新统计信息
- 重建索引
- 优化表结构

## 10. 附录

### 10.1 数据字典

| 术语 | 定义 |
|------|------|
| AgeStage | 成长阶段，如0-3岁、3-6岁等 |
| GrowthRecord | 记录孩子成长过程中的重要事件、里程碑等 |
| ChildProfile | 孩子的基本信息和成长数据 |
| GrowthAssessment | 基于成长记录生成的评估报告 |
| InteractionRecord | 记录亲子互动、学习活动等 |
| GeneratedVideo | AI生成的成长视频 |
| AIBook | AI生成的绘本故事 |

### 10.2 数据模型关系图

```
用户 (User)
  └─┬─ 孩子 (ChildProfile)
    │    ├─ 成长记录 (GrowthRecord)
    │    ├─ 成长评估 (GrowthAssessment)
    │    ├─ 里程碑 (Milestone)
    │    ├─ 互动记录 (InteractionRecord)
    │    ├─ 课程 (Course)
    │    │    └─ 课程安排 (CourseSchedule)
    │    ├─ 日程 (Schedule)
    │    ├─ 生成视频 (GeneratedVideo)
    │    └─ 绘本 (AIBook)
    └─ 阶段转换记录 (StageTransition)
```

---

**文档版本历史**

| 版本 | 日期 | 作者 | 变更说明 |
|------|------|------|----------|
| 1.0.0 | 2024-12-08 | YYC团队 | 初始版本 |

---

<div align="center">

> 「***YanYuCloudCube***」
> 「***<admin@0379.email>***」
> 「***Words Initiate Quadrants, Language Serves as Core for the Future***」
> 「***All things converge in the cloud pivot; Deep stacks ignite a new era of intelligence***」

</div>

